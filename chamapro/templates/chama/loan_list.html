{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}Loans | {{ chama.name }}{% endblock %}

{% block content %}
<section class="py-5">
    <div class="container">
        <div class="row mb-4 align-items-center">
            <div class="col">
                <h1 class="fw-bold">Loans: {{ chama.name }}</h1>
                <p class="text-muted mb-0">Manage loan requests and history.</p>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#loanRequestForm" aria-expanded="false">
                    Request New Loan
                </button>
            </div>
        </div>

        <!-- Loan Request Form (Collapsible) -->
        <div class="collapse mb-4" id="loanRequestForm">
            <div class="card card-body shadow-sm border-0 bg-light">
                <h5 class="card-title mb-3">New Loan Application</h5>
                <form method="post">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-5">
                            {{ form.amount|as_crispy_field }}
                        </div>
                        <div class="col-md-5">
                            {{ form.duration_months|as_crispy_field }}
                        </div>
                        <div class="col-md-2 d-flex align-items-end pb-3">
                            <button type="submit" class="btn btn-success w-100">Submit Request</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Loans Table -->
        <div class="card shadow-sm border-0">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4 py-3">Borrower</th>
                                <th class="py-3">Amount</th>
                                <th class="py-3">Interest</th>
                                <th class="py-3">Total Repayment</th>
                                <th class="py-3">Status</th>
                                <th class="py-3">Date Requested</th>
                                <th class="py-3 text-end pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for loan in loans %}
                            <tr>
                                <td class="ps-4">
                                    <div class="fw-bold">{{ loan.borrower.get_full_name|default:loan.borrower.username }}</div>
                                </td>
                                <td>KSh {{ loan.amount }}</td>
                                <td>{{ loan.interest_rate }}%</td>
                                <td>KSh {{ loan.total_repayment|floatformat:2 }}</td>
                                <td>
                                    {% if loan.status == 'PENDING' %}
                                        <span class="badge bg-warning text-dark">Pending</span>
                                    {% elif loan.status == 'APPROVED' %}
                                        <span class="badge bg-info">Approved</span>
                                    {% elif loan.status == 'REJECTED' %}
                                        <span class="badge bg-danger">Rejected</span>
                                    {% elif loan.status == 'DISBURSED' %}
                                        <span class="badge bg-primary">Disbursed</span>
                                    {% elif loan.status == 'PAID' %}
                                        <span class="badge bg-success">Paid</span>
                                    {% endif %}
                                </td>
                                <td>{{ loan.request_date|date:"M d, Y" }}</td>
                                <td class="text-end pe-4">
                                    {% if request.user == chama.created_by and loan.status == 'PENDING' %}
                                        <a href="{% url 'chama:approve_loan' chama.slug chama.id loan.id %}" class="btn btn-sm btn-success me-1">Approve</a>
                                        <a href="{% url 'chama:reject_loan' chama.slug chama.id loan.id %}" class="btn btn-sm btn-outline-danger">Reject</a>
                                    {% elif loan.status == 'APPROVED' and request.user == chama.created_by %}
                                        <button class="btn btn-sm btn-outline-primary" disabled>Disburse (Coming Soon)</button>
                                    {% else %}
                                        <span class="text-muted small">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center py-5">
                                    <p class="text-muted mb-0">No loan requests found.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="mt-3">
            <a href="{% url 'chama:chama_detail' chama.slug chama.id %}" class="btn btn-outline-secondary">&larr; Back to Chama</a>
        </div>
    </div>
</section>
{% endblock %}
